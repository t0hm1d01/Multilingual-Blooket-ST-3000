<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Blooket</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <header>
        <nav>
            <div class="logo">
                <img src="https://www.blooket.com/static/img/logo.png" alt="Blooket Logo">
            </div>
            <div class="volumeSlider">
                <label for="volume">Volume:</label>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="lang-menu">
                <div class="selected-lang">
                    <span id="current-lang-display">English</span>
                </div>
                <ul>
                    <li><a href="#" class="English">English</a></li>
                    <li><a href="#" class="Spanish">Spanish</a></li>
                    <li><a href="#" class="German">German</a></li>
                    <li><a href="#" class="French">French</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4">

        <div id="host-join-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-6">Choose Your Role</h2>
            <button id="host-game-btn-initial" class="btn btn-blue w-full mb-4 py-3">Host Game</button>
            <button id="show-join-game-btn" class="btn btn-green w-full py-3">Join Game</button>
            <p class="mt-4 text-sm text-gray-600">
                Host to create a new game and get a PIN, or Join an existing game with a PIN.
            </p>
        </div>

        <div id="login-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md hidden">
            <h1 id="greetings" class="text-3xl font-bold mb-4"></h1>
            <p id="description" class="text-gray-600 mb-6"></p>
            <input id="username-input" class="input-field" type="text" placeholder="Username">
            <input id="pin-input" class="input-field" type="text" placeholder="Game PIN">
            <button id="start-game-btn" class="btn btn-purple w-full py-3 mt-4">Start Game</button>
            <p id="error-message" class="text-red-500 mt-4 hidden"></p>
            <button id="back-to-host-join" class="btn btn-gray w-full py-2 mt-2">Back</button>
        </div>

        <div id="host-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md text-center hidden">
            <h2 class="text-2xl font-bold mb-4">Host Game</h2>
            <p class="text-lg mb-4">Share this PIN with your friends:</p>
            <div id="pin-display" class="text-5xl font-extrabold text-blue-600 mb-6 py-4 px-6 bg-blue-50 rounded-lg inline-block select-all"></div>
            <p class="text-sm text-gray-600 mb-4">Waiting for players to join...</p>
            <button id="start-hosted-game-btn" class="btn btn-purple w-full py-3 mt-4">Start Hosted Game</button>
            <button id="back-to-host-join-from-host" class="btn btn-gray w-full py-2 mt-2">Back</button>
        </div>

        <div id="leaderboard-section" class="bg-white p-6 rounded-lg shadow-md w-full max-w-xs ml-8 hidden md:block">
            <h3 class="text-xl font-bold mb-4 text-center">Leaderboard</h3>
            <div id="leaderboard-list" class="space-y-2">
                <p class="text-gray-500 text-center">Loading leaderboard...</p>
            </div>
        </div>

        <div id="game-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-lg hidden">
            <div class="flex justify-between items-center mb-6">
                <p class="text-lg font-semibold">Gold: <span id="gold-display" class="text-yellow-600">0.00</span></p>
                <p class="text-lg font-semibold">Time Left: <span id="timer-display" class="text-blue-600">05:00</span></p>
            </div>

            <div id="quiz-section">
                <h2 id="question-text" class="text-xl font-bold mb-6"></h2>
                <div id="answer-choices" class="grid grid-cols-1 gap-4">
                    </div>
            </div>

            <div id="bonus-section" class="hidden">
                <h2 class="text-xl font-bold mb-6 text-center">Choose Your Bonus!</h2>
                <div id="bonus-choices" class="grid grid-cols-1 gap-4">
                    </div>
            </div>
        </div>

        <div id="game-over-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md text-center hidden">
            <h2 class="text-3xl font-bold mb-4 text-red-600">Game Over!</h2>
            <p class="text-xl mb-4">Your Final Gold: <span id="final-gold-display" class="text-yellow-600 font-bold">0.00</span></p>
            <button id="play-again-btn" class="btn btn-blue w-full py-3 mt-4">Play Again</button>
        </div>

    </main>

    <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
            <p id="message-text" class="text-lg mb-4"></p>
            <button id="message-ok-btn" class="btn btn-purple py-2 px-6">OK</button>
        </div>
    </div>

    <audio id="music" src="your-background-music.mp3" loop muted></audio> <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9XoNDsTaqHcCn3gv9rU9fHQbOeH-10U0",
            authDomain: "multilingual-bloocket-3000.firebaseapp.com",
            projectId: "multilingual-bloocket-3000",
            storageBucket: "multilingual-bloocket-3000.firebasestorage.app",
            messagingSenderId: "566691790847",
            appId: "1:566691790847:web:c0345cb1a99467dd4631ca",
            measurementId: "G-KNBY3BWK3X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let generatedPin = '';
        let gold = 0;
        let timeLeft = 300;
        let timerInterval;
        let gameRunning = false;
        let currentQuestionIndex = 0;
        let username = '';
        let isHost = false; // New flag to distinguish host from joiner
        let gamePinRef = null; // Firestore document reference for the game PIN

        // --- UI Element References ---
        const hostJoinScreen = document.getElementById('host-join-screen');
        const hostGameBtnInitial = document.getElementById('host-game-btn-initial');
        const showJoinGameBtn = document.getElementById('show-join-game-btn');
        const hostScreen = document.getElementById('host-screen');
        const startHostedGameBtn = document.getElementById('start-hosted-game-btn');
        const backToHostJoinFromHostBtn = document.getElementById('back-to-host-join-from-host');

        const loginScreen = document.getElementById('login-screen');
        const usernameInput = document.getElementById('username-input');
        const pinInput = document.getElementById('pin-input');
        const pinDisplay = document.getElementById('pin-display');
        const startGameBtn = document.getElementById('start-game-btn');
        const errorMessage = document.getElementById('error-message');
        const backToHostJoinBtn = document.getElementById('back-to-host-join');

        const leaderboardSection = document.getElementById('leaderboard-section'); // New
        const leaderboardList = document.getElementById('leaderboard-list'); // Existing

        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const timerDisplay = document.getElementById('timer-display');
        const goldDisplay = document.getElementById('gold-display');
        const questionText = document.getElementById('question-text');
        const answerChoicesDiv = document.getElementById('answer-choices');
        const bonusSection = document.getElementById('bonus-section');
        const bonusChoicesDiv = document.getElementById('bonus-choices');
        const finalGoldDisplay = document.getElementById('final-gold-display');
        const playAgainBtn = document.getElementById('play-again-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const quizSection = document.getElementById('quiz-section');

        // References for language switching elements
        const greetingsElement = document.getElementById('greetings');
        const descriptionElement = document.getElementById('description');
        const langLinks = document.querySelectorAll('.lang-menu ul li a');
        const currentLangDisplay = document.getElementById('current-lang-display'); // New

        // --- Game Data Classes (Converted from Java) ---
        class ChoiceEffect {
            constructor(description, type, value) {
                this.description = description;
                this.type = type;
                this.value = value;
            }

            getDescription() {
                return this.description;
            }

            getType() {
                return this.type;
            }

            getValue() {
                return this.value;
            }

            applyEffect(currentGold) {
                if (this.type === 'PERCENTAGE_MULTIPLIER') {
                    let newGold = currentGold * this.value;
                    return newGold < 0 ? 0 : newGold;
                } else {
                    let newGold = currentGold + this.value;
                    return newGold < 0 ? 0 : newGold;
                }
            }
        }

        class Question {
            constructor(questionText, answerChoices, correctAnswer) {
                this.questionText = questionText;
                this.answerChoices = [...answerChoices];
                this.correctAnswer = correctAnswer;
                this.shuffleChoices();
            }

            shuffleChoices() {
                for (let i = this.answerChoices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.answerChoices[i], this.answerChoices[j]] = [this.answerChoices[j], this.answerChoices[i]];
                }
            }

            getQuestionText() {
                return this.questionText;
            }

            getAnswerChoices() {
                return [...this.answerChoices];
            }

            getCorrectAnswer() {
                return this.correctAnswer;
            }

            isCorrect(selectedAnswer) {
                return this.correctAnswer.trim().toLowerCase() === selectedAnswer.trim().toLowerCase();
            }
        }

        // --- Game Data Storage ---
        let questionBank = [];
        let allChoiceEffects = [];

        const LanguageData = {
            English: {
                name: "English",
                greeting: "Welcome to the Better Version of Blooket!!!",
                description: "Answer questions to earn gold, then pick a bonus!",
                host_game: "Host Game",
                join_game: "Join Game",
                choose_role: "Choose Your Role",
                share_pin: "Share this PIN with your friends:",
                waiting_players: "Waiting for players to join...",
                start_hosted: "Start Hosted Game",
                back: "Back",
                username_placeholder: "Username",
                pin_placeholder: "Game PIN",
                start_game: "Start Game",
                incorrect_pin: "Incorrect PIN. Please try again.",
                no_username: "Please enter a username.",
                correct: "Correct!",
                earned_gold: "You earned 100 Gold!",
                incorrect: "Incorrect.",
                lost_gold: "You lost 50 Gold!",
                correct_answer_was: "The correct answer was:",
                choose_bonus: "Choose Your Bonus!",
                gold_changed: "Your gold changed from",
                to: "to",
                game_over: "Game Over!",
                your_final_gold: "Your Final Gold:",
                play_again: "Play Again",
                loading_leaderboard: "Loading leaderboard...",
                no_scores: "No scores yet. Be the first!",
                error_leaderboard: "Error loading leaderboard.",
                authentication_failed: "Authentication failed. Please check your console for details.",
                submit_failed: "Failed to submit score. Please check your internet connection and Firebase setup.",
                ok: "OK"
            },
            Spanish: {
                name: "Español",
                greeting: "¡¡¡Bienvenido a la mejor versión de Blooket!!!",
                description: "¡Responde preguntas para ganar oro y luego elige un bono!",
                host_game: "Organizar Juego",
                join_game: "Unirse al Juego",
                choose_role: "Elige tu Rol",
                share_pin: "Comparte este PIN con tus amigos:",
                waiting_players: "Esperando a que los jugadores se unan...",
                start_hosted: "Iniciar Juego Organizado",
                back: "Atrás",
                username_placeholder: "Nombre de usuario",
                pin_placeholder: "PIN del Juego",
                start_game: "Iniciar Juego",
                incorrect_pin: "PIN incorrecto. Por favor, inténtalo de nuevo.",
                no_username: "Por favor, introduce un nombre de usuario.",
                correct: "¡Correcto!",
                earned_gold: "¡Ganaste 100 de oro!",
                incorrect: "Incorrecto.",
                lost_gold: "¡Perdiste 50 de oro!",
                correct_answer_was: "La respuesta correcta era:",
                choose_bonus: "¡Elige tu Bono!",
                gold_changed: "Tu oro cambió de",
                to: "a",
                game_over: "¡Juego Terminado!",
                your_final_gold: "Tu Oro Final:",
                play_again: "Jugar de Nuevo",
                loading_leaderboard: "Cargando clasificación...",
                no_scores: "Aún no hay puntuaciones. ¡Sé el primero!",
                error_leaderboard: "Error al cargar la clasificación.",
                authentication_failed: "Autenticación fallida. Por favor, revisa tu consola para más detalles.",
                submit_failed: "No se pudo enviar la puntuación. Por favor, verifica tu conexión a internet y configuración de Firebase.",
                ok: "OK"
            },
            German: {
                name: "Deutsch",
                greeting: "Willkommen zur besseren Version von Blooket!!!",
                description: "Beantworten Sie Fragen, um Gold zu verdienen, und wählen Sie dann einen Bonus aus!",
                host_game: "Spiel hosten",
                join_game: "Spiel beitreten",
                choose_role: "Wähle deine Rolle",
                share_pin: "Teile diesen PIN mit deinen Freunden:",
                waiting_players: "Warte auf Spieler...",
                start_hosted: "Gehostetes Spiel starten",
                back: "Zurück",
                username_placeholder: "Benutzername",
                pin_placeholder: "Spiel-PIN",
                start_game: "Spiel starten",
                incorrect_pin: "Falscher PIN. Bitte versuche es erneut.",
                no_username: "Bitte geben Sie einen Benutzernamen ein.",
                correct: "Richtig!",
                earned_gold: "Du hast 100 Gold verdient!",
                incorrect: "Falsch.",
                lost_gold: "Du hast 50 Gold verloren!",
                correct_answer_was: "Die richtige Antwort war:",
                choose_bonus: "Wähle deinen Bonus!",
                gold_changed: "Dein Gold änderte sich von",
                to: "zu",
                game_over: "Spiel vorbei!",
                your_final_gold: "Dein Endgold:",
                play_again: "Nochmal spielen",
                loading_leaderboard: "Bestenliste wird geladen...",
                no_scores: "Noch keine Punktzahlen. Sei der Erste!",
                error_leaderboard: "Fehler beim Laden der Bestenliste.",
                authentication_failed: "Authentifizierung fehlgeschlagen. Überprüfen Sie bitte Ihre Konsole auf Details.",
                submit_failed: "Fehler beim Einreichen der Punktzahl. Bitte überprüfen Sie Ihre Internetverbindung und Firebase-Einrichtung.",
                ok: "OK"
            },
            French: {
                name: "Français",
                greeting: "Bienvenue dans la meilleure version de Blooket !!!",
                description: "Répondez aux questions pour gagner de l'or, puis choisissez un bonus !",
                host_game: "Héberger une partie",
                join_game: "Rejoindre une partie",
                choose_role: "Choisissez votre rôle",
                share_pin: "Partagez ce code PIN avec vos amis :",
                waiting_players: "En attente de joueurs...",
                start_hosted: "Démarrer la partie hébergée",
                back: "Retour",
                username_placeholder: "Nom d'utilisateur",
                pin_placeholder: "Code PIN du jeu",
                start_game: "Démarrer la partie",
                incorrect_pin: "Code PIN incorrect. Veuillez réessayer.",
                no_username: "Veuillez entrer un nom d'utilisateur.",
                correct: "Correct !",
                earned_gold: "Vous avez gagné 100 Or !",
                incorrect: "Incorrect.",
                lost_gold: "Vous avez perdu 50 Or !",
                correct_answer_was: "La bonne réponse était :",
                choose_bonus: "Choisissez votre bonus !",
                gold_changed: "Votre or est passé de",
                to: "à",
                game_over: "Partie terminée !",
                your_final_gold: "Votre Or Final :",
                play_again: "Rejouer",
                loading_leaderboard: "Chargement du classement...",
                no_scores: "Pas encore de scores. Soyez le premier !",
                error_leaderboard: "Erreur lors du chargement du classement.",
                authentication_failed: "Échec de l'authentification. Veuillez vérifier votre console pour plus de détails.",
                submit_failed: "Échec de l'envoi du score. Veuillez vérifier votre connexion Internet et la configuration de Firebase.",
                ok: "OK"
            }
        };

        let currentLanguage = 'English'; // Default language

        // --- Initialization ---
        function initializeGameData() {
            questionBank = [
                new Question("What is the capital of France?", ["Paris", "Berlin", "Madrid", "Rome"], "Paris"),
                new Question("Which planet is known as the 'Red Planet'?", ["Mars", "Earth", "Jupiter", "Venus"], "Mars"),
                new Question("What is 7 + 8?", ["15", "12", "16", "14"], "15"),
                new Question("Who painted the Mona Lisa?", ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], "Leonardo da Vinci"),
                new Question("What is the largest ocean on Earth?", ["Atlantic Ocean", "Indian Ocean", "Arctic Ocean", "Pacific Ocean"], "Pacific Ocean"),
                new Question("What is the chemical symbol for water?", ["H2O", "CO2", "O2", "N2"], "H2O"),
                new Question("What is the fastest land animal?", ["Cheetah", "Lion", "Horse", "Gazelle"], "Cheetah"),
                new Question("How many continents are there?", ["5", "6", "7", "8"], "7"),
                new Question("What is the square root of 81?", ["7", "8", "9", "10"], "9"),
                new Question("Which gas do plants absorb from the atmosphere?", ["Oxygen", "Carbon Dioxide", "Nitrogen", "Hydrogen"], "Carbon Dioxide")
            ];

            allChoiceEffects = [
                new ChoiceEffect("+200% Gold", 'PERCENTAGE_MULTIPLIER', 3.0),
                new ChoiceEffect("+300% Gold", 'PERCENTAGE_MULTIPLIER', 4.0),
                new ChoiceEffect("-99% Gold", 'PERCENTAGE_MULTIPLIER', 0.01),
                new ChoiceEffect("-20% Gold", 'PERCENTAGE_MULTIPLIER', 0.8),
                new ChoiceEffect("-50% Gold", 'PERCENTAGE_MULTIPLIER', 0.5),
                new ChoiceEffect("+250 Gold", 'FLAT_AMOUNT', 250.0),
                new ChoiceEffect("+10 Gold", 'FLAT_AMOUNT', 10.0),
                new ChoiceEffect("+500 Gold", 'FLAT_AMOUNT', 500.0),
                new ChoiceEffect("-100 Gold", 'FLAT_AMOUNT', -100.0),
                new ChoiceEffect("-200 Gold", 'FLAT_AMOUNT', -200.0),
                new ChoiceEffect("No Change", 'FLAT_AMOUNT', 0.0)
            ];
        }

        // --- Authentication ---
        async function authenticateUser() {
            try {
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("Authenticated as:", userId);
                listenForLeaderboardUpdates();
            } catch (error) {
                console.error("Authentication error:", error);
                showMessage(LanguageData[currentLanguage].authentication_failed);
            }
        }

        // --- PIN Generation and Validation (Host/Join) ---
        async function generatePin() {
            let pin = '';
            let isUnique = false;
            while (!isUnique) {
                pin = Math.floor(1000 + Math.random() * 9000).toString(); // 4-digit PIN
                const docRef = doc(db, "gamePins", pin);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    isUnique = true;
                }
            }
            generatedPin = pin;
            pinDisplay.textContent = generatedPin;
            gamePinRef = doc(db, "gamePins", generatedPin);
            await setDoc(gamePinRef, {
                hostId: userId,
                status: "waiting", // waiting, active, finished
                players: [],
                createdAt: serverTimestamp(),
                currentQuestionIndex: 0,
                hostGold: 0 // Initialize host's gold, others will have their own local gold
            });
            console.log("Game PIN generated and created in Firestore:", generatedPin);
        }

        async function joinGame() {
            username = usernameInput.value.trim();
            const enteredPin = pinInput.value.trim();

            if (!username) {
                errorMessage.textContent = LanguageData[currentLanguage].no_username;
                errorMessage.classList.remove('hidden');
                return;
            }
            if (!enteredPin) {
                errorMessage.textContent = LanguageData[currentLanguage].incorrect_pin; // Re-use for empty
                errorMessage.classList.remove('hidden');
                return;
            }

            gamePinRef = doc(db, "gamePins", enteredPin);
            const docSnap = await getDoc(gamePinRef);

            if (!docSnap.exists()) {
                errorMessage.textContent = LanguageData[currentLanguage].incorrect_pin;
                errorMessage.classList.remove('hidden');
                return;
            }

            const gameData = docSnap.data();
            if (gameData.status !== "waiting") {
                errorMessage.textContent = "This game has already started or is finished.";
                errorMessage.classList.remove('hidden');
                return;
            }

            // Add player to the game's player list in Firestore
            await setDoc(gamePinRef, {
                players: [...gameData.players, { id: userId, username: username, gold: 0 }],
                // You might also want to set status to 'active' if the host starts
            }, { merge: true });

            errorMessage.classList.add('hidden');
            loginScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameOverScreen.classList.add('hidden');
            leaderboardSection.classList.add('hidden'); // Hide leaderboard when game starts

            gold = 0;
            timeLeft = 300; // Reset timer to 5 minutes
            currentQuestionIndex = 0;
            gameRunning = true;
            updateGoldDisplay();
            updateTimerDisplay();
            // In a multiplayer game, questions would be controlled by the host or a shared state
            // For now, still shuffle locally for joined players.
            shuffleQuestionBank();
            displayQuestion();
            startTimer();

            // Listen for game state changes from the host
            onSnapshot(gamePinRef, (doc) => {
                const data = doc.data();
                if (data && data.status === "active" && !isHost) {
                    // Host has started the game, ensure we're on the game screen
                    if (gameScreen.classList.contains('hidden')) {
                         loginScreen.classList.add('hidden');
                         hostScreen.classList.add('hidden');
                         hostJoinScreen.classList.add('hidden');
                         gameScreen.classList.remove('hidden');
                         leaderboardSection.classList.add('hidden');
                         // Optionally re-sync game state from host if needed
                    }
                }
                // Handle new questions, bonus choices based on host actions
                if (data && data.currentQuestionIndex !== undefined && data.currentQuestionIndex !== currentQuestionIndex) {
                    currentQuestionIndex = data.currentQuestionIndex;
                    displayQuestion();
                }
                // Potentially sync gold or other states if the game is truly centralized
            });
        }


        // --- Game Flow Functions ---
        function startGameAsHost() {
            // This is for the host to officially start the game after generating PIN
            hostScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            leaderboardSection.classList.add('hidden'); // Hide leaderboard when game starts

            gold = 0;
            timeLeft = 300;
            currentQuestionIndex = 0;
            gameRunning = true;
            updateGoldDisplay();
            updateTimerDisplay();
            shuffleQuestionBank();
            displayQuestion();
            startTimer();

            // Update game status in Firestore
            if (gamePinRef) {
                setDoc(gamePinRef, { status: "active", hostGold: gold, currentQuestionIndex: currentQuestionIndex }, { merge: true });
            }
        }

        function resetGame() {
            gameOverScreen.classList.add('hidden');
            hostJoinScreen.classList.remove('hidden'); // Go back to host/join screen
            usernameInput.value = '';
            pinInput.value = '';
            generatedPin = ''; // Clear generated PIN
            pinDisplay.textContent = ''; // Clear PIN display
            leaderboardList.innerHTML = '<p class="text-gray-500 text-center">Loading leaderboard...</p>';
            stopTimer();
            leaderboardSection.classList.remove('hidden'); // Show leaderboard again
            isHost = false; // Reset host status
            gamePinRef = null; // Clear game PIN reference
        }

        function endGame() {
            gameRunning = false;
            stopTimer();
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            finalGoldDisplay.textContent = gold.toFixed(2);
            submitScore(username, gold);

            // Update game status in Firestore if host
            if (isHost && gamePinRef) {
                setDoc(gamePinRef, { status: "finished", hostFinalGold: gold }, { merge: true });
            }
        }

        // --- Quiz Functions ---
        function shuffleQuestionBank() {
            for (let i = questionBank.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questionBank[i], questionBank[j]] = [questionBank[j], questionBank[i]];
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex < questionBank.length) {
                const question = questionBank[currentQuestionIndex];
                questionText.textContent = question.getQuestionText();
                answerChoicesDiv.innerHTML = '';

                question.getAnswerChoices().forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.textContent = choice;
                    button.classList.add('question-choices', 'btn', `choice-${index}`);
                    button.addEventListener('click', () => handleAnswer(choice, question.getCorrectAnswer(), button));
                    answerChoicesDiv.appendChild(button);
                });

                quizSection.classList.remove('hidden');
                bonusSection.classList.add('hidden');
            } else {
                endGame();
            }
        }

        function handleAnswer(selectedChoice, correctAnswer, clickedButton) {
            Array.from(answerChoicesDiv.children).forEach(button => button.disabled = true);

            const isCorrect = (selectedChoice.trim().toLowerCase() === correctAnswer.trim().toLowerCase());

            if (isCorrect){
                clickedButton.classList.add('correct');
                gold += 100.0;
                showMessage(`${LanguageData[currentLanguage].correct} ${LanguageData[currentLanguage].earned_gold}`, () => {
                    displayBonusChoices();
                });
            } else {
                clickedButton.classList.add('incorrect');
                Array.from(answerChoicesDiv.children).forEach(button => {
                    if (button.textContent.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
                        button.classList.add('correct');
                    }
                });
                gold -= 50.0;
                if (gold < 0) gold = 0;
                showMessage(`${LanguageData[currentLanguage].incorrect} ${LanguageData[currentLanguage].correct_answer_was} ${correctAnswer}. ${LanguageData[currentLanguage].lost_gold}`, () => {
                    displayBonusChoices();
                });
            }
            updateGoldDisplay();

            // If host, update shared gold state
            if (isHost && gamePinRef) {
                 setDoc(gamePinRef, { hostGold: gold }, { merge: true });
            }
        }

        function displayBonusChoices() {
            quizSection.classList.add('hidden');
            bonusSection.classList.remove('hidden');
            bonusChoicesDiv.innerHTML = '';

            const shuffledEffects = [...allChoiceEffects].sort(() => 0.5 - Math.random());
            const selectedBonusOptions = shuffledEffects.slice(0, 3);

            selectedBonusOptions.forEach(effect => {
                const button = document.createElement('button');
                button.textContent = effect.getDescription();
                button.classList.add('bonus-choice-btn', 'btn');
                button.addEventListener('click', () => handleBonusChoice(effect));
                bonusChoicesDiv.appendChild(button);
            });
        }

        function handleBonusChoice(chosenEffect) {
            const oldGold = gold;
            gold = chosenEffect.applyEffect(gold);
            updateGoldDisplay();

            showMessage(`${LanguageData[currentLanguage].gold_changed} ${oldGold.toFixed(2)} ${LanguageData[currentLanguage].to} ${gold.toFixed(2)}.`, () => {
                currentQuestionIndex++;
                // If host, update shared question index
                if (isHost && gamePinRef) {
                    setDoc(gamePinRef, { currentQuestionIndex: currentQuestionIndex }, { merge: true });
                }
                displayQuestion();
            });
        }

        // --- Timer Functions ---
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateGoldDisplay() {
            goldDisplay.textContent = gold.toFixed(2);
        }

        // --- Leaderboard Functions ---
        async function submitScore(username, score) {
            try {
                await addDoc(collection(db, "leaderboard"), {
                    username: username,
                    score: score,
                    timestamp: serverTimestamp()
                });
                console.log("Score submitted successfully!");
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage(LanguageData[currentLanguage].submit_failed);
            }
        }

        function listenForLeaderboardUpdates() {
            const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                leaderboardList.innerHTML = '';
                if (snapshot.empty) {
                    leaderboardList.innerHTML = `<p class="text-gray-500 text-center">${LanguageData[currentLanguage].no_scores}</p>`;
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('div');
                    listItem.classList.add('leaderboard-item');
                    listItem.innerHTML = `
                        <span class="font-semibold">${data.username}</span>
                        <span class="text-yellow-600 font-semibold">${data.score.toFixed(2)} Gold</span>
                    `;
                    leaderboardList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error listening to leaderboard updates:", error);
                leaderboardList.innerHTML = `<p class="text-red-500 text-center">${LanguageData[currentLanguage].error_leaderboard}</p>`;
            });
        }

        // --- Custom Message Box ---
        function showMessage(text, callback) {
            messageText.textContent = text;
            messageOkBtn.textContent = LanguageData[currentLanguage].ok;
            messageBox.classList.remove('hidden');
            messageOkBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) {
                    callback();
                }
            };
        }

        // --- Language Switching ---
        function changeLanguage(languageCode) {
            currentLanguage = languageCode;
            const data = LanguageData[languageCode];
            if (data) {
                // Update text content of various elements
                greetingsElement.textContent = data.greeting;
                descriptionElement.textContent = data.description;
                hostGameBtnInitial.textContent = data.host_game;
                showJoinGameBtn.textContent = data.join_game;
                document.querySelector('#host-join-screen h2').textContent = data.choose_role;
                document.querySelector('#host-screen h2').textContent = data.host_game;
                document.querySelector('#host-screen p').textContent = data.share_pin;
                document.querySelector('#host-screen p:last-of-type').textContent = data.waiting_players;
                startHostedGameBtn.textContent = data.start_hosted;
                backToHostJoinFromHostBtn.textContent = data.back;
                usernameInput.placeholder = data.username_placeholder;
                pinInput.placeholder = data.pin_placeholder;
                startGameBtn.textContent = data.start_game;
                backToHostJoinBtn.textContent = data.back;
                document.querySelector('#game-over-screen h2').textContent = data.game_over;
                document.querySelector('#game-over-screen p').innerHTML = `${data.your_final_gold} <span id="final-gold-display" class="text-yellow-600 font-bold">${gold.toFixed(2)}</span>`;
                playAgainBtn.textContent = data.play_again;
                currentLangDisplay.textContent = data.name; // Update display in language menu
            }
        }

        langLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const languageCode = e.target.className;
                changeLanguage(languageCode);
            });
        });

        // --- Music Control ---
        const music = document.getElementById('music');
        const volumeSlider = document.getElementById('volume'); // Corrected ID

        let hasInteracted = false;
        document.body.addEventListener('click', function() {
            if (!hasInteracted) {
                music.muted = false;
                music.play().catch(e => console.error("Error playing music:", e));
                hasInteracted = true;
            }
        }, { once: true });

        volumeSlider.addEventListener('input', function() {
            music.volume = this.value;
        });


        // --- Event Listeners ---
        hostGameBtnInitial.addEventListener('click', async () => {
            hostJoinScreen.classList.add('hidden');
            hostScreen.classList.remove('hidden');
            isHost = true;
            await generatePin(); // Generate PIN for the host
        });

        showJoinGameBtn.addEventListener('click', () => {
            hostJoinScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            isHost = false;
        });

        startHostedGameBtn.addEventListener('click', startGameAsHost); // New button for host to start

        startGameBtn.addEventListener('click', joinGame); // Now handles joining logic

        backToHostJoinBtn.addEventListener('click', resetGame); // Use resetGame to go back to initial screen
        backToHostJoinFromHostBtn.addEventListener('click', resetGame); // Use resetGame to go back to initial screen

        playAgainBtn.addEventListener('click', resetGame);

        // Initialize on page load
        window.onload = async () => {
            initializeGameData();
            await authenticateUser();
            changeLanguage('English'); // Set initial language
            // Initial view is host/join screen, leaderboard is visible
            hostJoinScreen.classList.remove('hidden');
            leaderboardSection.classList.remove('hidden');
        };
    </script>
</body>
</html>
